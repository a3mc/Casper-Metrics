### Deploy In Production

##### In this document we provide an overview on the production deployment.

The platform core components consist of various independent units:

* Fail tolerate MySQL cluster
* Master crawler server
* Replication operator servers
* Load balancer
* Static front end
* Mail server

Each of these components is recommended to be deployed separately.

__Database__

Collected data stored in MySQL database, doing asynchronous crawling process where is a lot of simultaneous connections created, this will require database tuning, database need to be optimised for high performance, connections need to be increased depends on crawler setup, crawler can be configured by following guidance in [.env] and adjustments can be made based on stats gained from monitoring dashboards. See monitoring section below.

Depends on particular need, MySQL can be hosted together with Master Crawler and cluster can be spread between Replication Operators, in most cases dev-ops have database in hands and configuration will be new database creation and this is it.

MySQL source and replicas communication require strict TLS policy as data flow can contain sensitive material in case of administration panel implementation. There are no passwords or login credentials stored directly, but please follow best practices if possible.

**Master crawler**

In case of crawling from scratch, significant load will be observed on Master Crawler through all crawling process.

We recommend to use dedicated servers for Master Crawler deployment. Please have a look on [Hardware Requirements](https://github.com/a3mc/Casper-Metrics/blob/master/docs/REQUIREMENTS.md)

But if crawling is not planned as for example we import database from external source, then all load comes from the API consumption, which can be close to none in case of individual research or when used by small applications. Master Crawler can serve all components and provide healthy performance as a crawler, API server, reverse proxy and front-end host altogether.

Idle crawler routine resource consumption are close to none where is minimum bandwidth consumption, complete deployment can be set on large EC2 instance and serve basic needs perfectly in scenarios where is no heavy queries performed in large quantity.

Master Crawler uses Redis to achieve its high speed performance. As latency there is important, it is preferable to have Redis installed on the same machine with the crawler, however, it can be set on separately depending on the existing infrastructure policy and implementation.

**Replication operators**

Role of Replication Operators is to serve metrics by request of load balancer. These units process read-only operations, where is no load on this servers doing crawling process, however, load  comes from API queries and this should be considered when choosing hardware. If API is not planned for heavy usage where is no need of Replication Operators and everything can be built around Master Crawler server instead. For more information please follow [Hardware Requirements](https://github.com/a3mc/Casper-Metrics/blob/master/docs/REQUIREMENTS.md) guidance.

**Load Balancer**

Load balancer splits the load generated by the API consumers between Master Crawler Server and Replication Operators. To optimise performance different caching rules have to be set for each endpoint. Historical data can have long-living cache, where the real-time data needs to be processed in a micro-cache scenario. The short cache has to be at least little less than the current block time, as for example 1 ~ 8 second in a good starting point. For speed and performance cache storage need to be split between multiple tmpfs volumes, big enough swap space should be implemented and cache configuration set accordingly. Long cache rules for archive can be set to a longer time range, as for example 1 ~ 6 hours or above. Admin endpoints require real-time communication and should be processed without any cache implementation. Where is a lot of possibilities in cache optimisation, dev-ops need to make decision based on many factors starting from general deployment purpose and follow the existing infrastructure policy, advanced load balancer options and hardware specification _( RAM, CPU, Storage performance, bandwidth accessibility )_.

**Static components**

We recommend to set up all static components on a cloud such as AWS, for example, for better availability, performance and stability.

Admin Interface theoretically will never fall under high load and can be served separately. All admin traffic needs to be strictly encrypted on all stages, endpoints need to be covered with SSL certificate. SSL certificates issuance can be automated and proceed without any downtime whatsoever, following best practice in this area are strongly recommended.

### Monitoring

Monitoring can be achieved with Prometheus and Grafana combo as for example. Grafana can play role of alerting system and watches all dedicated servers together with the MySQL cluster, mail server and TLS encryption status, SSL certificates issuance, reverse proxy load and additional metrics as general API consumption. We recommend implementing metrics in wide range here as in case of high load environment configuration will require additional tweaks and this will be hard to implement without having metrics in place across all infrastructure components.

**Mail server**

Mail server in optional as it used for administrator operations only, in case admin interface is not required by user, mail server can be ignored, if administration panel implemented, mail server credentials can be configured in `.env` file. See the [example.env](https://github.com/a3mc/Casper-Metrics/blob/master/example.env) for details.

**Continuous integration**

Continuous integration is recommended and can be implemented for all components as in case of production deployment we need to upgrade infrastructure without any downtime, please follow best practice if possible.

For more details, follow: [Hardware Requirements](https://github.com/a3mc/Casper-Metrics/blob/master/docs/REQUIREMENTS.md).

#### Basic structure of the production setup

![Structure](https://github.com/a3mc/Casper-Metrics/blob/master/docs/infrastructure-map.jpg)
